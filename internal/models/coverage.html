<!DOCTYPE html>
<html>

<head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>models: Go Coverage Report</title>
        <style>
                body {
                        background: black;
                        color: rgb(80, 80, 80);
                }

                body,
                pre,
                #legend span {
                        font-family: Menlo, monospace;
                        font-weight: bold;
                }

                #topbar {
                        background: black;
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 42px;
                        border-bottom: 1px solid rgb(80, 80, 80);
                }

                #content {
                        margin-top: 50px;
                }

                #nav,
                #legend {
                        float: left;
                        margin-left: 10px;
                }

                #legend {
                        margin-top: 12px;
                }

                #nav {
                        margin-top: 10px;
                }

                #legend span {
                        margin: 0 5px;
                }

                .cov0 {
                        color: rgb(192, 0, 0)
                }

                .cov1 {
                        color: rgb(128, 128, 128)
                }

                .cov2 {
                        color: rgb(116, 140, 131)
                }

                .cov3 {
                        color: rgb(104, 152, 134)
                }

                .cov4 {
                        color: rgb(92, 164, 137)
                }

                .cov5 {
                        color: rgb(80, 176, 140)
                }

                .cov6 {
                        color: rgb(68, 188, 143)
                }

                .cov7 {
                        color: rgb(56, 200, 146)
                }

                .cov8 {
                        color: rgb(44, 212, 149)
                }

                .cov9 {
                        color: rgb(32, 224, 152)
                }

                .cov10 {
                        color: rgb(20, 236, 155)
                }
        </style>
</head>

<body>
        <div id="topbar">
                <div id="nav">
                        <select id="files">

                                <option value="file0">homework_platform/internal/models/comment.go (36.8%)</option>

                                <option value="file1">homework_platform/internal/models/complaint.go (0.0%)</option>

                                <option value="file2">homework_platform/internal/models/course.go (68.0%)</option>

                                <option value="file3">homework_platform/internal/models/homework.go (78.7%)</option>

                                <option value="file4">homework_platform/internal/models/homework_submission.go (33.7%)
                                </option>

                                <option value="file5">homework_platform/internal/models/init.go (0.0%)</option>

                                <option value="file6">homework_platform/internal/models/user.go (68.4%)</option>

                        </select>
                </div>
                <div id="legend">
                        <span>not tracked</span>

                        <span class="cov0">not covered</span>
                        <span class="cov8">covered</span>

                </div>
        </div>
        <div id="content">

                <pre class="file" id="file0" style="display: none">package models

import (
        // "errors"
        "homework_platform/internal/bootstrap"
        "log"
        "math/rand"
        "time"

        "gorm.io/gorm"
)

type Comment struct {
        gorm.Model

        // A homework submission has many comments
        // Also check homework_submission.go
        // Check: https://gorm.io/docs/has_many.html
        HomeworkSubmissionID uint `json:"homeworkSubmissionId"`
        HomeworkID           uint `json:"homeworkid"`
        // A user has many comments
        // Also check user.go
        // Check: https://gorm.io/docs/has_many.html
        UserID uint `json:"userId"`

        // Regular fields
        Comment string `json:"comment"`
        Score   int    `json:"score" gorm:"default:-1"`
}

// 计算已经有几个人批过了
func GetCommentNum(homeworksubmission_id uint) uint <span class="cov0" title="0">{
        comments, err := GetCommentBySubmissionID(homeworksubmission_id)
        if err != nil </span><span class="cov0" title="0">{
                return 0
        }</span>
        <span class="cov0" title="0">var num uint
        num = 0
        for _, comment := range comments </span><span class="cov0" title="0">{
                if comment.Score != -1 </span><span class="cov0" title="0">{
                        num += 1
                }</span>
        }
        <span class="cov0" title="0">return num</span>
}

func (comment Comment) UpdateSelf(comm string, score int) error <span class="cov8" title="1">{
        res := DB.Model(&amp;comment).Updates(Comment{Comment: comm, Score: score})
        return res.Error
}</span>

func GetCommentBySubmissionID(submissionid uint) ([]Comment, error) <span class="cov8" title="1">{
        var comments []Comment
        res := DB.Where("homework_submission_id = ?", submissionid).Find(&amp;comments)
        if res.Error != nil </span><span class="cov0" title="0">{
                return nil, res.Error
        }</span>
        <span class="cov8" title="1">return comments, nil</span>
}

func GetCommentsByHomeworkId(HomeworkID uint) ([]Comment, error) <span class="cov0" title="0">{
        var comments []Comment
        err := DB.Where("homework_id=?", HomeworkID).Find(&amp;comments)
        if err.Error != nil </span><span class="cov0" title="0">{
                return nil, err.Error
        }</span>
        <span class="cov0" title="0">return comments, nil</span>
}

func GetCommentByUserIDAndHomeworkSubmissionID(userid uint, homeworksubmissionid uint) (any, error) <span class="cov8" title="1">{
        var comment Comment
        res := DB.Where("homework_submission_id = ? AND user_id = ?", homeworksubmissionid, userid).First(&amp;comment)
        if res.Error != nil </span><span class="cov0" title="0">{
                return nil, res.Error
        }</span>
        <span class="cov8" title="1">return comment, nil</span>
}

func GetCommentListsByUserIDAndHomeworkID(userId uint, homeworkId uint) ([]Comment, error) <span class="cov8" title="1">{
        var comment []Comment
        log.Printf("正在查找 comments&lt;user_id:%d,homeworkId:%d&gt;\n", userId, homeworkId)
        res := DB.Where("homework_id = ? AND user_id = ?", homeworkId, userId).Find(&amp;comment)
        if res.Error != nil </span><span class="cov0" title="0">{
                return nil, res.Error
        }</span>
        <span class="cov8" title="1">return comment, nil</span>
}

func CreateComment(HomeworkSubmissionID uint, UserID uint, HomeworkID uint) bool <span class="cov8" title="1">{
        log.Printf("正在创建comment&lt;user_id:%d,homework_submission_id:%d&gt;", UserID, HomeworkSubmissionID)
        if bootstrap.Sqlite </span><span class="cov8" title="1">{
                _, err := GetUserByID(UserID)
                if err != nil </span><span class="cov8" title="1">{
                        log.Printf("用户&lt;user_id:%d&gt;不存在", UserID)
                        return false
                }</span>
                <span class="cov8" title="1">res := GetHomeWorkSubmissionByID(HomeworkSubmissionID)
                if res == nil </span><span class="cov8" title="1">{
                        log.Printf("作业提交&lt;submission:id:%d&gt;不存在", HomeworkSubmissionID)
                        return false
                }</span>
        }

        <span class="cov8" title="1">comment := Comment{
                HomeworkSubmissionID: HomeworkSubmissionID,
                UserID:               UserID,
                HomeworkID:           HomeworkID,
        }
        res := DB.Create(&amp;comment)
        return res.Error == nil</span>
}

func AssignComment(HomeworkID uint) error <span class="cov0" title="0">{
        // 在这里我们进行作业的分配,每次如果作业没有被分配并且时间到了那么我们就分配!
        homework, err := GetHomeworkByID(HomeworkID)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">if homework.Assigned == 1 || homework.EndDate.After(time.Now()) </span><span class="cov0" title="0">{
                return nil
        }</span>

        // 分配作业
        <span class="cov0" title="0">submissionLists, err := GetSubmissionListsByHomeworkID(HomeworkID)
        if err != nil </span><span class="cov0" title="0">{
                log.Println("no")
                return err
        }</span>

        // TODO: 算法部分,暂时采用每人批三份的方式
        <span class="cov0" title="0">submittedUsers, err := GetSubmittedUsers(HomeworkID)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">log.Printf("[AssignComment]: Submitted users: %x", len(submittedUsers))
        userCommentCnt := make(map[uint]int)

        nReviewers := min(3, len(submittedUsers)-1)
        log.Printf("[AssignComment]: nReviewers: %x", nReviewers)

        for _, submission := range submissionLists </span><span class="cov0" title="0">{
                for cnt := 0; cnt &lt; nReviewers; cnt++ </span><span class="cov0" title="0">{
                        // Find a user to comment this submission
                        targetUserId := submittedUsers[rand.Intn(len(submittedUsers))].ID
                        for targetUserId == submission.UserID || userCommentCnt[targetUserId] &gt;= nReviewers </span><span class="cov0" title="0">{
                                targetUserId = submittedUsers[rand.Intn(len(submittedUsers))].ID
                        }</span>
                        <span class="cov0" title="0">userCommentCnt[targetUserId]++

                        CreateComment(submission.ID, targetUserId, submission.HomeworkID)</span>
                }
        }

        // var userLists []uint
        // if len(submissionLists) &lt;= nReviewers {
        //         //少于3人,那么直接分配其他的人就行
        //         for _, users := range submissionLists {
        //                 for _, submission := range submissionLists {
        //                         if users.ID != submission.ID {
        //                                 CreateComment(submission.ID, users.UserID, submission.HomeworkID)
        //                         }
        //                 }
        //         }
        // } else {
        //         for _, submission := range submissionLists {
        //                 m[submission.UserID] = nReviewers
        //                 userLists = append(userLists, submission.UserID)
        //         }
        //         for _, submission := range submissionLists { //在这里获取提交用户的id
        //                 var used []uint
        //                 for i := 0; i &lt; nReviewers; i++ {
        //                         for {
        //                                 k := rand.Intn(int(len(userLists)))
        //                                 found := false
        //                                 for _, z := range used {
        //                                         if int(z) == k {
        //                                                 found = true
        //                                                 break
        //                                         }
        //                                 }
        //                                 if userLists[k] != submission.UserID &amp;&amp; m[userLists[k]] &gt; 0 &amp;&amp; !found {
        //                                         CreateComment(submission.ID, userLists[k], submission.HomeworkID)
        //                                         used = append(used, uint(k))
        //                                         m[userLists[k]]--
        //                                         break
        //                                 }
        //                         }
        //                 }
        //         }
        // }

        <span class="cov0" title="0">homework.Assigned = 1 //标志位,表示是否已经被分配
        DB.Save(&amp;homework)

        return nil</span>
}

func DeleteCommentsByHomeworkID(homeworkID uint) error <span class="cov0" title="0">{
        result := DB.Where("homework_id = ?", homeworkID).Delete(&amp;Comment{})
        if result.Error != nil </span><span class="cov0" title="0">{
                // 处理删除错误
                log.Fatal(result.Error)
                return result.Error
        }</span>
        <span class="cov0" title="0">return nil</span>
}
</pre>

                <pre class="file" id="file1" style="display: none">package models

import (
        "log"

        "gorm.io/gorm"
)

type Complaint struct {
        gorm.Model

        UserID               uint   `form:"userId"`
        TeacherID            uint   `form:"teacherId"`
        HomeworkSubmissionID uint   `form:"homeworkSubmissionId"`
        HomeworkID           uint   `form:"homeworkId"`
        CourseID             uint   `form:"courseId"`
        Solved               bool   `form:"solved"`
        Reason               string `form:"reason"`
}

func CreateTeacherComplaint(submissionId uint, homeworkId uint, CourseID uint, reason string) error <span class="cov0" title="0">{
        log.Printf("正在创建&lt;Complaint&gt;(SubmissionId = %d)...", submissionId)
        homeworkSubmission := GetHomeWorkSubmissionByID(submissionId)

        course, err := GetCourseByID(CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">complaint := Complaint{HomeworkSubmissionID: submissionId,
                HomeworkID: homeworkId,
                CourseID:   CourseID,
                Reason:     reason,
                UserID:     homeworkSubmission.ID,
                TeacherID:  course.TeacherID,
        }
        complaint.Solved = false
        res := DB.Create(&amp;complaint)
        if res.Error == nil </span><span class="cov0" title="0">{
                log.Printf("创建完成&lt;Complaint&gt;(ID = %v)", complaint.ID)
        }</span>
        <span class="cov0" title="0">return res.Error</span>
}

func DeleteComplaint(complaintId uint) error <span class="cov0" title="0">{
        log.Printf("正在删除修改请求&lt;Complaint&gt;(id = %d)...", complaintId)
        complaint, err := GetComplaintById(complaintId)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">res := DB.Delete(&amp;complaint)
        return res.Error</span>
}

func SolveComplaint(complaintID uint) error <span class="cov0" title="0">{
        complaint, err := GetComplaintById(complaintID)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">complaint.Solved = true
        res := DB.Save(&amp;complaint)
        return res.Error</span>
}

func GetComplaintById(Id uint) (Complaint, error) <span class="cov0" title="0">{
        log.Printf("正在查找&lt;Complaint&gt;(ID = %d)...", Id)
        var complaint Complaint

        res := DB.Where("homework_submission_id=?", Id).First(&amp;complaint)
        if res.Error != nil </span><span class="cov0" title="0">{
                log.Printf("查找失败: %s", res.Error)
                return complaint, res.Error
        }</span>
        <span class="cov0" title="0">return complaint, nil</span>
}

func (complaint *Complaint) Save() error <span class="cov0" title="0">{
        res := DB.Save(&amp;complaint)
        return res.Error
}</span>

func GetComplaintBySubmissionID(submissionId uint) (Complaint, error) <span class="cov0" title="0">{
        log.Printf("正在查找&lt;Complaint&gt;(submissionId = %d)...", submissionId)
        var complaint Complaint

        res := DB.Where("homework_submission_id=?", submissionId).First(&amp;complaint)
        if res.Error != nil </span><span class="cov0" title="0">{
                log.Printf("查找失败: %s", res.Error)
                return complaint, res.Error
        }</span>
        <span class="cov0" title="0">return complaint, nil</span>
}

func GetComplaintByHomeworkID(homeworkId uint) ([]Complaint, error) <span class="cov0" title="0">{
        log.Printf("正在查找&lt;Complaint&gt;(homeworkId = %d)...", homeworkId)
        var complaints []Complaint

        res := DB.Where("homework_id=?", homeworkId).Find(&amp;complaints)
        if res.Error != nil </span><span class="cov0" title="0">{
                log.Printf("查找失败: %s", res.Error)
                return complaints, res.Error
        }</span>
        <span class="cov0" title="0">return complaints, nil</span>
}

func GetComplaintByUserID(UserID uint) ([]Complaint, error) <span class="cov0" title="0">{
        log.Printf("正在查找&lt;Complaint&gt;(userId = %d)...", UserID)
        var complaint []Complaint

        res := DB.Where("user_id=? and solved=0", UserID).Find(&amp;complaint)
        if res.Error != nil </span><span class="cov0" title="0">{
                log.Printf("查找失败: %s", res.Error)
                return complaint, res.Error
        }</span>
        <span class="cov0" title="0">return complaint, nil</span>
}

func GetComplaintByTeacherID(teacherId uint) ([]Complaint, error) <span class="cov0" title="0">{
        log.Printf("正在查找&lt;Complaint&gt;(TeacherID = %d)...", teacherId)
        var complaint []Complaint

        res := DB.Where("teacher_id=? and solved = 0", teacherId).Find(&amp;complaint)
        if res.Error != nil </span><span class="cov0" title="0">{
                log.Printf("查找失败: %s", res.Error)
                return complaint, res.Error
        }</span>
        <span class="cov0" title="0">return complaint, nil</span>
}
</pre>

                <pre class="file" id="file2" style="display: none">package models

import (
        "errors"
        "log"
        "time"

        "gorm.io/gorm"
)

type Course struct {
        gorm.Model
        Name        string    `json:"name"`
        BeginDate   time.Time `json:"beginDate"`
        EndDate     time.Time `json:"endDate"`
        Description string    `json:"description"`

        // A teacher has many course
        // Also check user.go
        // Check: https://gorm.io/docs/has_many.html
        TeacherID uint `json:"teacherID"`

        // A student has many Course, a course has many students
        // Also check user.go
        // Check: https://gorm.io/docs/many_to_many.html
        Students []*User `json:"-" gorm:"many2many:user_courses;constraint:OnDelete:CASCADE"`

        // A course has many homework
        // Also check homework.go
        // Check: https://gorm.io/docs/has_many.html
        Homeworks []Homework `json:"-" gorm:"foreignKey:CourseID;constraint:OnDelete:CASCADE"`

        Complaints []Complaint `josn:"-" gorm:"constraint:OnDelete:CASCADE"`
}

func (course Course) GetHomeworkLists() ([]Homework, error) <span class="cov8" title="1">{
        res := DB.Preload("Homeworks").First(&amp;course, course.ID)

        if res.Error != nil </span><span class="cov0" title="0">{
                return nil, res.Error
        }</span>
        <span class="cov8" title="1">homeworks := course.Homeworks
        for i := 0; i &lt; len(homeworks); i++ </span><span class="cov8" title="1">{
                homeworks[i].GetFiles()
        }</span>
        <span class="cov8" title="1">return homeworks, nil</span>
}

func (course Course) GetStudents() ([]*User, error) <span class="cov8" title="1">{
        res := DB.Preload("Students").First(&amp;course)
        if res.Error != nil </span><span class="cov0" title="0">{
                return nil, res.Error
        }</span>
        <span class="cov8" title="1">return course.Students, nil</span>
}

func (course Course) FindStudents(id uint) bool <span class="cov0" title="0">{
        var students []*User
        err := DB.Model(&amp;course).Association("Students").Find(&amp;students, "id = ?", id)
        if err != nil </span><span class="cov0" title="0">{
                log.Println(err)
                return false
        }</span>

        <span class="cov0" title="0">log.Println(students)
        return len(students) &gt; 0</span>
}

func SelectCourse(userId uint, courseId uint) error <span class="cov0" title="0">{
        course, err := GetCourseByID(courseId)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">user, err := GetUserByID(userId)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">res := course.GetStudentsByID(userId)
        if res </span><span class="cov0" title="0">{
                return errors.New("无法重复选课")
        }</span>
        <span class="cov0" title="0">user.LearningCourses = append(user.LearningCourses, &amp;course)
        result := DB.Save(&amp;user)
        return result.Error</span>
}

func (course Course) SelectCourse(id uint) error <span class="cov8" title="1">{
        res := course.GetStudentsByID(id)
        if res </span><span class="cov8" title="1">{
                return errors.New("无法重复选课")
        }</span>
        //查看该用户是否已经选择了course
        <span class="cov8" title="1">user, err := GetUserByID(id)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>
        <span class="cov8" title="1">user.LearningCourses = append(user.LearningCourses, &amp;course)
        result := DB.Save(&amp;user)
        return result.Error</span>

}

func (course Course) UpdateCourseDescription(description string) bool <span class="cov8" title="1">{
        result := DB.Model(&amp;course).Updates(Course{Description: description})
        return result.Error == nil
}</span>

func (course Course) GetStudentsByID(id uint) bool <span class="cov8" title="1">{
        userlists, err := course.GetStudents()
        if err != nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov8" title="1">for _, user := range userlists </span><span class="cov8" title="1">{
                if user.ID == id </span><span class="cov8" title="1">{
                        return true
                }</span>
        }
        <span class="cov8" title="1">return false</span>
}

func GetCourses() ([]Course, error) <span class="cov8" title="1">{
        var courses []Course
        err := DB.Find(&amp;courses).Error
        return courses, err
}</span>

func CreateCourse(name string, begindate time.Time,
        enddate time.Time, description string, teachderID uint) (uint, error) <span class="cov8" title="1">{
        log.Printf("正在创建&lt;Course&gt;(name = %s)", name)
        if len(name) == 0 </span><span class="cov8" title="1">{
                log.Printf("创建失败,课程名不能为空")
                return 0, errors.New("创建失败")
        }</span>
        <span class="cov8" title="1">if enddate.Before(begindate) </span><span class="cov8" title="1">{
                log.Printf("创建失败,开始时间不能晚于结束时间")
                return 0, errors.New("创建失败")
        }</span>
        <span class="cov8" title="1">c := Course{
                Name:        name,
                BeginDate:   begindate,
                EndDate:     enddate,
                Description: description,
                TeacherID:   uint(teachderID),
        }
        res := DB.Create(&amp;c)
        if res.Error != nil </span><span class="cov0" title="0">{
                return 0, errors.New("创建失败")
        }</span>

        <span class="cov8" title="1">return c.ID, nil</span>
}

func GetCourseByID(id uint) (Course, error) <span class="cov8" title="1">{
        log.Printf("正在查找&lt;Course&gt;(ID = %d)...", id)
        var course Course

        res := DB.First(&amp;course, id)
        if res.Error != nil </span><span class="cov8" title="1">{
                log.Printf("查找失败: %s", res.Error)
                return course, res.Error
        }</span>
        <span class="cov8" title="1">log.Printf("查找完成: &lt;Course&gt;(CourseName = %s)", course.Name)
        return course, nil</span>
}

func (course Course) Deleteself() error <span class="cov8" title="1">{
        res := DB.Delete(&amp;course)
        if res.Error != nil </span><span class="cov0" title="0">{
                return res.Error
        }</span>
        <span class="cov8" title="1">return nil</span>
}
</pre>

                <pre class="file" id="file3" style="display: none">package models

import (
        "errors"
        "fmt"
        "homework_platform/internal/bootstrap"
        "io/ioutil"
        "log"
        "path/filepath"
        "time"

        "gorm.io/gorm"
)

type Homework struct {
        gorm.Model
        CourseID       uint      `json:"courseId" gorm:"type:int(20)"`
        Name           string    `json:"name" gorm:"type:varchar(255)"`
        Description    string    `json:"description"`
        BeginDate      time.Time `json:"beginDate"`
        EndDate        time.Time `json:"endDate"`
        CommentEndDate time.Time `json:"commentEndDate"`
        Assigned       int       `json:"-" gorm:"default:-1"`
        // A homework has many submissions
        // Also check homeworkSubmission.go
        // Check: https://gorm.io/docs/has_many.html
        HomeworkSubmissions []HomeworkSubmission `json:"-" gorm:"constraint:OnDelete:CASCADE"`
        FilePaths           []string             `json:"file_paths" gorm:"-"`
}

func (homework *Homework) GetFiles() <span class="cov8" title="1">{
        root := fmt.Sprintf("./data/homeworkassign/%d/", homework.ID)
        files, err := ioutil.ReadDir(root)
        if err == nil </span><span class="cov0" title="0">{
                for _, file := range files </span><span class="cov0" title="0">{
                        if file.IsDir() </span><span class="cov0" title="0">{
                                continue</span>
                        }
                        <span class="cov0" title="0">homework.FilePaths = append(homework.FilePaths, filepath.Join(root, file.Name()))</span>
                }
        }
}

func (homework *Homework) UpdateInformation(name string, desciption string, beginDate time.Time, endDate time.Time, commentendate time.Time) bool <span class="cov8" title="1">{
        log.Printf("正在修改homework&lt;id:%d&gt;的详细信息", homework.ID)
        if beginDate.After(endDate) </span><span class="cov8" title="1">{
                log.Printf("homework&lt;id:%d&gt;:开始时间不可晚于结束时间", homework.ID)
                return false
        }</span>
        <span class="cov8" title="1">if endDate.After(commentendate) </span><span class="cov8" title="1">{
                log.Printf("homework&lt;id:%d&gt;:结束时间不可晚于批阅时间", homework.ID)
                return false
        }</span>
        <span class="cov8" title="1">if name == "" </span><span class="cov8" title="1">{
                log.Printf("homework&lt;id:%d&gt;:作业名字不可为空", homework.ID)
                return false
        }</span>
        <span class="cov8" title="1">if desciption == "" </span><span class="cov8" title="1">{
                log.Printf("homework&lt;name:%d&gt;:作业内容不可为空", homework.ID)
                return false
        }</span>
        <span class="cov8" title="1">result := DB.Model(&amp;homework).Updates(Homework{
                Name: name, Description: desciption, BeginDate: beginDate, EndDate: endDate, CommentEndDate: commentendate,
        })
        return result.Error == nil</span>
}

func (homeworkd Homework) Deleteself() error <span class="cov8" title="1">{
        res := DB.Delete(&amp;homeworkd)
        if res.Error != nil </span><span class="cov0" title="0">{
                return res.Error
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func CreateHomework(id uint, name string, description string,
        begindate time.Time, endtime time.Time, commentendate time.Time) (any, error) <span class="cov8" title="1">{
        log.Printf("正在创建作业&lt;id=%d&gt;", id)
        if begindate.After(endtime) </span><span class="cov8" title="1">{
                return nil, errors.New("结束时间不可早于开始时间")
        }</span>
        <span class="cov8" title="1">if endtime.After(commentendate) </span><span class="cov8" title="1">{
                return nil, errors.New("评论开始时间不可早于结束时间")
        }</span>
        <span class="cov8" title="1">log.Printf("homework&lt;name:%s&gt;:正在创建作业", name)
        if name == "" </span><span class="cov8" title="1">{
                log.Printf("homework&lt;name:%s&gt;:作业名字不可为空", name)
                return nil, errors.New("名称不可为空")
        }</span>
        <span class="cov8" title="1">if description == "" </span><span class="cov8" title="1">{
                log.Printf("homework&lt;name:%s&gt;:作业内容不可为空", name)
                return nil, errors.New("内容不可为空")
        }</span>
        <span class="cov8" title="1">if bootstrap.Sqlite </span><span class="cov8" title="1">{
                //TODO:这里好像sqlite不会生成外键约束
                _, err := GetCourseByID(id)
                if err != nil </span><span class="cov8" title="1">{
                        return nil, errors.New("课程不存在")
                }</span>
        }
        <span class="cov8" title="1">newhomework := Homework{
                CourseID:       id,
                Name:           name,
                Description:    description,
                BeginDate:      begindate,
                EndDate:        endtime,
                CommentEndDate: commentendate,
        }
        res := DB.Create(&amp;newhomework)
        if res.Error != nil </span><span class="cov0" title="0">{
                log.Printf("homework&lt;name:%s&gt;:创建作业失败", name)
                return nil, errors.New("创建失败")
        }</span>
        <span class="cov8" title="1">log.Printf("homework&lt;name:%s&gt;:创建作业成功,作业id为%d", name, newhomework.ID)
        return newhomework, nil</span>
}

func GetHomeworkByID(id uint) (Homework, error) <span class="cov8" title="1">{
        log.Printf("正在查找&lt;Homework&gt;(ID = %d)...", id)
        var work Homework
        res := DB.First(&amp;work, id)
        if res.Error != nil </span><span class="cov8" title="1">{
                log.Printf("查找失败: %s", res.Error)
                return work, res.Error
        }</span>
        <span class="cov8" title="1">work.GetFiles()
        log.Printf("查找完成: &lt;Homeworkd&gt;(homeworkName = %s)", work.Name)
        return work, nil</span>
}

func GetHomeworkByIDWithSubmissionLists(id uint) (Homework, error) <span class="cov8" title="1">{
        log.Printf("正在查找&lt;Homework&gt;(ID = %d)...", id)
        var work Homework

        res := DB.Preload("HomeworkSubmissions").First(&amp;work, id)
        if res.Error != nil </span><span class="cov8" title="1">{
                log.Printf("查找失败: %s", res.Error)
                return work, res.Error
        }</span>
        <span class="cov8" title="1">log.Printf("查找完成: &lt;Homeworkd&gt;(homeworkName = %s)", work.Name)
        return work, nil</span>
}

func GetSubmittedUsers(id uint) ([]User, error) <span class="cov0" title="0">{
        homework, err := GetHomeworkByIDWithSubmissionLists(id)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">users := []User{}
        for _, submissions := range homework.HomeworkSubmissions </span><span class="cov0" title="0">{
                user, err := GetUserByID(submissions.UserID)
                if err == nil </span><span class="cov0" title="0">{
                        users = append(users, user)
                }</span>
        }

        <span class="cov0" title="0">return users, nil</span>
}</pre>

                <pre class="file" id="file4" style="display: none">package models

import (
        "fmt"
        "homework_platform/internal/bootstrap"
        "io/ioutil"
        "log"
        "math"
        "path/filepath"
        "time"

        "gorm.io/gorm"
)

type HomeworkSubmission struct {
        gorm.Model

        // A homework has many homework submission
        // Also check homework.go
        // Check: https://gorm.io/docs/has_many.html
        HomeworkID uint `json:"homeworkId"`

        // A User has many homework submission
        // Also check user.go
        // Check: https://gorm.io/docs/has_many.html
        UserID    uint     `json:"userId"`
        FilePaths []string `json:"file_paths" gorm:"-"`
        // Regular fields
        Content        string      `json:"content"`
        Score          int         `json:"score" gorm:"default:-1"` //-1表示不是最终结果
        Comments       []Comment   `josn:"-" gorm:"constraint:OnDelete:CASCADE"`
        Complaints []Complaint `josn:"-" gorm:"constraint:OnDelete:CASCADE"`
}

func (homeworksubmission *HomeworkSubmission) GetFiles() <span class="cov8" title="1">{
        root := fmt.Sprintf("./data/homeworkassign/%d/", homeworksubmission.ID)
        files, err := ioutil.ReadDir(root)
        if err == nil </span><span class="cov0" title="0">{
                for _, file := range files </span><span class="cov0" title="0">{
                        if file.IsDir() </span><span class="cov0" title="0">{
                                continue</span>
                        }
                        <span class="cov0" title="0">homeworksubmission.FilePaths = append(homeworksubmission.FilePaths, filepath.Join(root, file.Name()))</span>
                }
        }
}

func GetHomeWorkSubmissionListsByHomeworkID(homeworkID uint) []HomeworkSubmission <span class="cov0" title="0">{
        var homework_submission []HomeworkSubmission
        res := DB.Where("homework_id = ?", homeworkID).Find(&amp;homework_submission)
        if res.Error != nil </span><span class="cov0" title="0">{
                return nil
        }</span>
        <span class="cov0" title="0">return homework_submission</span>
}

// TODO:后续测试,计算成绩
func (submission *HomeworkSubmission) CalculateGrade() <span class="cov0" title="0">{
        //查询到所有的comment
        homewrork, err := GetHomeworkByID(submission.HomeworkID)
        if homewrork.CommentEndDate.Before(time.Now()) </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">comments, res := GetCommentBySubmissionID(submission.ID)
        if res != nil </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">if len(comments) == 0 </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">grade := 0.0
        totalDegree := 0.0
        totalDegreeWithoutDegree := 0
        var userList []User
        var gradeList []int
        for _, comment := range comments </span><span class="cov0" title="0">{
                if comment.Score == -1 </span><span class="cov0" title="0">{
                        continue</span>
                }
                <span class="cov0" title="0">user, err := GetUserByID(comment.UserID)
                if err != nil </span><span class="cov0" title="0">{
                        return
                }</span>
                <span class="cov0" title="0">totalDegree += user.DegreeOfConfidence
                totalDegreeWithoutDegree += comment.Score
                userList = append(userList, user)
                gradeList = append(gradeList, comment.Score)
                grade += float64(comment.Score) * float64(user.DegreeOfConfidence)</span> //TODO:在这里进行算法开发
        }
        <span class="cov0" title="0">if grade == 0 </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">flag := false
        if submission.Score == -1 </span><span class="cov0" title="0">{
                flag = true
        }</span>
        <span class="cov0" title="0">average := float64(grade) / totalDegree
        average = math.Round(average)
        submission.UpdateGrade(int(average))
        if flag </span><span class="cov0" title="0">{
                //TODO:更新degree,不过我是懒B,只算第一次计算
                for i := 0; i &lt; len(userList); i++ </span><span class="cov0" title="0">{
                        userList[i].UpdateDegree(int(average), gradeList[i])
                }</span>
        }

}

// TODO:后续测试,计算成绩
func (submission *HomeworkSubmission) UpdateGrade(Score int) error <span class="cov0" title="0">{
        submission.Score = Score
        return DB.Save(&amp;submission).Error
}</span>

func (homeworksubmission HomeworkSubmission) UpdateSelf() error <span class="cov8" title="1">{
        log.Printf("正在修改homeoworksubmission&lt;id:%d&gt;", homeworksubmission.ID)
        return DB.Save(&amp;homeworksubmission).Error
}</span>

func AddHomeworkSubmission(work *HomeworkSubmission) bool <span class="cov8" title="1">{
        log.Printf("正在创建homeworksubmission&lt;user_id:%d,homework_id:%d&gt;", work.UserID, work.HomeworkID)
        if bootstrap.Sqlite </span><span class="cov8" title="1">{
                _, err := GetUserByID(work.UserID)
                if err != nil </span><span class="cov8" title="1">{
                        log.Printf("homeworksubmission&lt;user_id:%d,homework_id:%d&gt;:user not exist!", work.UserID, work.HomeworkID)
                        return false
                }</span>
                <span class="cov8" title="1">_, err = GetHomeworkByID(work.HomeworkID)
                if err != nil </span><span class="cov8" title="1">{
                        log.Printf("homeworksubmission&lt;user_id:%d,homework_id:%d&gt;:homework not exist!", work.UserID, work.HomeworkID)
                        return false
                }</span>
        }
        <span class="cov8" title="1">res := DB.Create(&amp;work)
        return res.Error == nil</span>
}

func GetHomeWorkSubmissionByHomeworkIDAndUserID(homeworkID uint, userID uint) *HomeworkSubmission <span class="cov8" title="1">{
        var submission *HomeworkSubmission
        if err := DB.Where("user_id = ? AND homework_id = ?", userID, homeworkID).First(&amp;submission).Error; err != nil </span><span class="cov8" title="1">{
                return nil
        }</span>

        <span class="cov8" title="1">if submission.ID != 0 </span><span class="cov8" title="1">{
                return submission
        }</span> else<span class="cov0" title="0"> {
                return nil
        }</span>
}

func GetHomeWorkSubmissionByID(homewroksubmissionid uint) *HomeworkSubmission <span class="cov8" title="1">{
        var homewroksubmission HomeworkSubmission
        res := DB.First(&amp;homewroksubmission, homewroksubmissionid)
        if res.Error != nil </span><span class="cov8" title="1">{
                return nil
        }</span>
        <span class="cov8" title="1">homewroksubmission.GetFiles()
        return &amp;homewroksubmission</span>
}

func GetSubmissionListsByHomeworkID(id uint) ([]HomeworkSubmission, error) <span class="cov0" title="0">{
        var submission []HomeworkSubmission
        if err := DB.Where("homework_id = ?", id).Find(&amp;submission).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">for i := 0; i &lt; len(submission); i++ </span><span class="cov0" title="0">{
                submission[i].GetFiles()
        }</span>
        <span class="cov0" title="0">return submission, nil</span>
}
</pre>

                <pre class="file" id="file5" style="display: none">package models

import (
        "homework_platform/internal/bootstrap"
        "homework_platform/internal/utils"
        "log"

        "github.com/glebarez/sqlite"
        "gorm.io/driver/mysql"
        "gorm.io/driver/postgres"
        "gorm.io/gorm/logger"

        // "gocloud.dev/mysql"
        "gorm.io/gorm"
)

var DB *gorm.DB

func InitDB() <span class="cov0" title="0">{
        // db, err := gorm.Open(sqlite.Open("ach.db"), &amp;gorm.Config{})
        // db, err := gorm.Open(mysql.Open(bootstrap.Config.SQLDSN), &amp;gorm.Config{})
        var db *gorm.DB
        var err error
        if bootstrap.Sqlite </span><span class="cov0" title="0">{
                db, err = gorm.Open(sqlite.Open("homework-platform.db"), &amp;gorm.Config{})
                sqlDB, err := db.DB()
                sqlDB.SetMaxOpenConns(1)
                if err != nil </span><span class="cov0" title="0">{
                        log.Panicln("无法设置连接池")
                }</span>
        } else<span class="cov0" title="0"> if bootstrap.Mysql </span><span class="cov0" title="0">{
                db, err = gorm.Open(mysql.Open(bootstrap.Config.SQLDSN), &amp;gorm.Config{})
        }</span> else<span class="cov0" title="0"> if bootstrap.Test </span><span class="cov0" title="0">{
                db, err = gorm.Open(sqlite.Open(":memory:"), &amp;gorm.Config{
                        Logger: logger.Default.LogMode(logger.Silent),
                })
                log.Println("正在使用memory sqlite数据库")
        }</span> else<span class="cov0" title="0"> {
                db, err = gorm.Open(postgres.Open(bootstrap.Config.SQLDSN), &amp;gorm.Config{})
        }</span>

        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                log.Panicf("无法连接数据库，%s", err)
        }</span>

        <span class="cov0" title="0">DB = db
        DB.AutoMigrate(&amp;User{})
        DB.AutoMigrate(&amp;Course{})
        DB.AutoMigrate(&amp;Homework{})
        DB.AutoMigrate(&amp;HomeworkSubmission{})
        DB.AutoMigrate(&amp;Comment{})
        DB.AutoMigrate(&amp;Complaint{})
        // 创建初始管理员账户
        addDefaultUser()</span>
}

func addDefaultUser() <span class="cov0" title="0">{
        _, err := GetUserByID(1)
        password := utils.RandStringRunes(8)

        if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                defaultUser := &amp;User{}

                defaultUser.Username = "Admin"
                defaultUser.Password = utils.EncodePassword(password, utils.RandStringRunes(16))
                defaultUser.IsAdmin = true

                if err := DB.Create(&amp;defaultUser).Error; err != nil </span><span class="cov0" title="0">{
                        log.Panicf("创建初始管理员账户失败: %s\n", err)
                }</span>

                <span class="cov0" title="0">log.Println("初始管理员账户创建完成")
                log.Printf("用户名: %s\n", "Admin")
                log.Printf("密码: %s\n", password)</span>
        }
}
</pre>

                <pre class="file" id="file6" style="display: none">package models

import (
        "errors"
        "homework_platform/internal/utils"
        "log"
        "math"
        "strings"
        // "gorm.io/gorm"
)

type User struct {
        // gorm.Model
        ID        uint   `json:"id" gorm:"primaryKey"`
        Username  string `json:"username" gorm:"unique"` // 用户名
        Password  string `json:"-"`                      // 密码
        IsAdmin   bool   `json:"isAdmin"`                // 是否是管理员
        Signature string `json:"signature"`              // 用户个性签名
        ////// Associations //////
        // A user has many courses
        // Also check course.go
        // Check: https://gorm.io/docs/has_many.html
        TeachingCourses []*Course `json:"-" gorm:"foreignKey:TeacherID;constraint:OnDelete:CASCADE"` //引用了Course这个字段作为外键

        // A student has many courses, a course has many students
        // Also check course.go
        // Check: https://gorm.io/docs/many_to_many.html
        LearningCourses []*Course `json:"-" gorm:"many2many:user_courses;constraint:OnDelete:CASCADE"`

        // A user has many homework submissions
        // Also check homework_submissions.go
        // Check: https://gorm.io/docs/has_many.html
        HomeworkSubmissions []HomeworkSubmission `json:"-" gorm:"constraint:OnDelete:CASCADE"`

        // A user has many comments
        // Also check comment.go
        // Check: https://gorm.io/docs/has_many.html
        Comments []Comment `json:"-" gorm:"constraint:OnDelete:CASCADE"`

        Complaints []Complaint `josn:"-" gorm:"constraint:OnDelete:CASCADE"`
        // 算法设计,根据置信度的比率来打分和,在根据均值的偏差计算置信度
        DegreeOfConfidence float64 `json:"-" gorm:"default:0.5"`
}

func (user *User) CheckPassword(password string) bool <span class="cov8" title="1">{
        salt := strings.Split(user.Password, ":")[0]
        log.Printf("用户密码为: %s", user.Password)
        log.Printf("盐: %s", salt)

        return user.Password == utils.EncodePassword(password, salt)
}</span>

func (user *User) UpdateDegree(averageGrade int, myGrade int) error <span class="cov0" title="0">{
        //如何更新,上限为700,下限为300
        //TODO:更新权重算法
        diff := math.Abs(float64(averageGrade - myGrade))
        //更新动量为当abs()
        if diff &lt; 5 </span><span class="cov0" title="0">{
                user.DegreeOfConfidence += -2*diff + 10
        }</span> else<span class="cov0" title="0"> {
                user.DegreeOfConfidence -= 10*diff/95 - 50.0/95.0
        }</span>
        <span class="cov0" title="0">if user.DegreeOfConfidence &gt; 700 </span><span class="cov0" title="0">{
                user.DegreeOfConfidence = 700
        }</span> else<span class="cov0" title="0"> if user.DegreeOfConfidence &lt; 300 </span><span class="cov0" title="0">{
                user.DegreeOfConfidence = 300
        }</span>
        <span class="cov0" title="0">result := DB.Model(&amp;user).Updates(User{DegreeOfConfidence: user.DegreeOfConfidence})
        return result.Error</span>
}

func (user *User) ChangeSignature(signature string) error <span class="cov0" title="0">{
        log.Printf("正在修改签名&lt;User&gt;(Username = %s, Signature = %s)...", user.Username, signature)
        result := DB.Model(&amp;user).Updates(User{Signature: signature})
        return result.Error
}</span>

func (user *User) ChangePassword(password string) bool <span class="cov8" title="1">{
        log.Printf("正在修改密码&lt;User&gt;(Username = %s, Password = %s)...", user.Username, password)
        if len(password) == 0 </span><span class="cov8" title="1">{
                log.Printf("修改失败,用户密码不能为空")
                return false
        }</span>
        <span class="cov8" title="1">result := DB.Model(&amp;user).Updates(User{Password: utils.EncodePassword(password, utils.RandStringRunes(16))})
        return result.Error == nil</span>
}

func (user *User) GetTeachingCourse() ([]*Course, error) <span class="cov8" title="1">{
        res := DB.Preload("TeachingCourses").First(&amp;user)
        if res.Error != nil </span><span class="cov0" title="0">{
                return nil, res.Error
        }</span>
        <span class="cov8" title="1">return user.TeachingCourses, nil</span>
}

func (user *User) GetLearningCourse() ([]*Course, error) <span class="cov8" title="1">{
        res := DB.Preload("LearningCourses").First(&amp;user)
        if res.Error != nil </span><span class="cov0" title="0">{
                return nil, res.Error
        }</span>
        <span class="cov8" title="1">return user.LearningCourses, nil</span>
}

func (user *User) DeleteSelf() bool <span class="cov8" title="1">{
        log.Printf("正在删除用户&lt;User&gt;(Username = %s)...", user.Username)
        res := DB.Delete(&amp;user)
        return res.Error == nil
}</span>

func CreateUser(username string, password string) (uint, error) <span class="cov8" title="1">{
        log.Printf("正在创建&lt;User&gt;(Username = %s, Password = %s)...", username, password)
        if len(username) == 0 </span><span class="cov8" title="1">{
                return 0, errors.New("名称不能为空")
        }</span>
        <span class="cov8" title="1">if len(password) == 0 </span><span class="cov8" title="1">{
                return 0, errors.New("密码不能为空")
        }</span>
        <span class="cov8" title="1">password = utils.EncodePassword(password, utils.RandStringRunes(16))
        user := User{Username: username, Password: password, IsAdmin: false} //默认创建的用户权限为普通用户

        res := DB.Create(&amp;user)
        if res.Error == nil </span><span class="cov8" title="1">{
                log.Printf("创建完成&lt;User&gt;(ID = %v, Username = %s, Password = %s)...", user.ID, user.Username, user.Password)
        }</span>
        <span class="cov8" title="1">return user.ID, res.Error</span>
}

func GetUserByID(id uint) (User, error) <span class="cov8" title="1">{
        log.Printf("正在查找&lt;User&gt;(ID = %d)...", id)
        var user User

        res := DB.First(&amp;user, id)
        if res.Error != nil </span><span class="cov8" title="1">{
                log.Printf("查找失败: %s", res.Error)
                return user, res.Error
        }</span>
        <span class="cov8" title="1">log.Printf("查找完成: &lt;User&gt;(Username = %s)", user.Username)
        return user, nil</span>
}

func GetUserByUsername(username string) (User, error) <span class="cov8" title="1">{
        log.Printf("正在查找&lt;User&gt;(Username = %s)...", username)
        var user User

        res := DB.Where("username = ?", username).First(&amp;user)
        if res.Error != nil </span><span class="cov8" title="1">{
                log.Printf("查找失败: %s", res.Error)
                return user, res.Error
        }</span>
        <span class="cov8" title="1">log.Printf("查找完成: &lt;User&gt;(Username = %s)", user.Username)
        return user, nil</span>
}

func GetUserList() ([]User, error) <span class="cov8" title="1">{
        log.Println("正在获取所有 User...")
        var userList = make([]User, 0)

        res := DB.Find(&amp;userList)
        if res.Error != nil </span><span class="cov0" title="0">{
                log.Printf("获取失败: %s", res.Error)
                return userList, res.Error
        }</span>
        <span class="cov8" title="1">log.Printf("获取完成：共 %d 条数据", len(userList))

        return userList, nil</span>
}

const (
        Learning = iota
        Teaching
)

type UserCourse struct {
        TeachingCourses []*Course `json:"teachingCourses"`
        LearningCourses []*Course `json:"learningCourses"`
}

func (user *User) GetCourses() (UserCourse, error) <span class="cov0" title="0">{
        var res UserCourse
        var err error

        if res.TeachingCourses, err = user.GetTeachingCourse(); err != nil </span><span class="cov0" title="0">{
                return res, nil
        }</span>
        <span class="cov0" title="0">if res.LearningCourses, err = user.GetLearningCourse(); err != nil </span><span class="cov0" title="0">{
                return res, nil
        }</span>
        <span class="cov0" title="0">return res, nil</span>
}
</pre>

        </div>
</body>
<script>
        (function () {
                var files = document.getElementById('files');
                var visible;
                files.addEventListener('change', onChange, false);
                function select(part) {
                        if (visible)
                                visible.style.display = 'none';
                        visible = document.getElementById(part);
                        if (!visible)
                                return;
                        files.value = part;
                        visible.style.display = 'block';
                        location.hash = part;
                }
                function onChange() {
                        select(files.value);
                        window.scrollTo(0, 0);
                }
                if (location.hash != "") {
                        select(location.hash.substr(1));
                }
                if (!visible) {
                        select("file0");
                }
        })();
</script>

</html>