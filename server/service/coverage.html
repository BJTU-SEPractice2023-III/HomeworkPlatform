
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>service: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">homework_platform/server/service/admin.go (89.5%)</option>
				
				<option value="file1">homework_platform/server/service/comment.go (82.6%)</option>
				
				<option value="file2">homework_platform/server/service/complaint.go (82.4%)</option>
				
				<option value="file3">homework_platform/server/service/course.go (69.3%)</option>
				
				<option value="file4">homework_platform/server/service/file.go (92.9%)</option>
				
				<option value="file5">homework_platform/server/service/grade.go (85.2%)</option>
				
				<option value="file6">homework_platform/server/service/homework.go (65.7%)</option>
				
				<option value="file7">homework_platform/server/service/homework_submission.go (79.0%)</option>
				
				<option value="file8">homework_platform/server/service/service.go (84.6%)</option>
				
				<option value="file9">homework_platform/server/service/user.go (78.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package service

import (
        "errors"
        "homework_platform/internal/models"

        // "homework_platform/internal/utils"

        "github.com/gin-gonic/gin"
)

type GetUsersService struct{}

func (service *GetUsersService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        return models.GetUserList()
}</span>

type DeleteUserService struct {
        ID uint `uri:"id" binding:"required"`
}

func (service *DeleteUserService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        user, err := models.GetUserByID(service.ID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, errors.New("用户不存在")
        }</span>
        <span class="cov8" title="1">result := user.DeleteSelf()
        if !result </span><span class="cov0" title="0">{
                return nil, errors.New("删除失败")
        }</span>
        <span class="cov8" title="1">res := make(map[string]any)
        res["msg"] = "删除成功"
        return res, nil</span>
}

type UserUpdateService struct { //管理员修改密码
        Username string `form:"username"` // 用户名
        Password string `form:"password"` //新密码
}

func (service *UserUpdateService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        user, err := models.GetUserByUsername(service.Username)
        if err != nil </span><span class="cov8" title="1">{
                return nil, errors.New("该用户不存在")
        }</span>
        <span class="cov8" title="1">result := user.ChangePassword(service.Password)
        if !result </span><span class="cov0" title="0">{
                return nil, errors.New("修改失败")
        }</span>
        <span class="cov8" title="1">res := make(map[string]any)
        res["msg"] = "修改成功"
        return res, nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package service

import (
        "errors"
        "homework_platform/internal/models"
        "log"
        "time"

        "github.com/gin-gonic/gin"
)

type CommentService struct {
        Score                int    `form:"score"`
        Comment              string `form:"comment"`
        HomeworkSubmissionID uint   `uri:"id" binding:"required"`
}

func (service *CommentService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        err := c.ShouldBindUri(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        //绑定reason
        <span class="cov8" title="1">err = c.ShouldBind(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">log.Println(service)
        if service.Score &lt; 0 || service.Score &gt; 100 </span><span class="cov8" title="1">{
                return nil, errors.New("无效分数")
        }</span>
        <span class="cov8" title="1">if service.Comment == "" </span><span class="cov8" title="1">{
                return nil, errors.New("评论为空")
        }</span>
        <span class="cov8" title="1">homewroksubmission := models.GetHomeWorkSubmissionByID(service.HomeworkSubmissionID)
        homework, res1 := models.GetHomeworkByID(homewroksubmission.HomeworkID)
        if res1 != nil </span><span class="cov0" title="0">{
                return nil, res1
        }</span>
        <span class="cov8" title="1">if homework.CommentEndDate.Before(time.Now()) </span><span class="cov0" title="0">{
                return nil, errors.New("超时批阅")
        }</span>
        <span class="cov8" title="1">if homewroksubmission == nil </span><span class="cov0" title="0">{
                return nil, errors.New("没有找到该作业号")
        }</span>
        <span class="cov8" title="1">id, _ := c.Get("ID")
        // comment是预先分配好的,所以不需要自我创建
        comment, err := models.GetCommentByUserIDAndHomeworkSubmissionID(id.(uint), service.HomeworkSubmissionID)
        if err == nil </span><span class="cov8" title="1">{
                res := comment.(models.Comment).UpdateSelf(service.Comment, service.Score)
                num, len := models.GetCommentNum(service.HomeworkSubmissionID)
                if num == len </span><span class="cov8" title="1">{
                        homewroksubmission.CalculateGrade()
                }</span>
                <span class="cov8" title="1">return nil, res</span>
        }
        <span class="cov0" title="0">return nil, err</span>
}

type GetCommentListsService struct {
        HomeworkID uint `uri:"id" binding:"required"`
}

func (service *GetCommentListsService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        log.Println("[GetCommentListsService]: Trying to assign comments")
        if err := models.AssignComment(service.HomeworkID); err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">homework, err := models.GetHomeworkByID(service.HomeworkID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">course, err := models.GetCourseByID(homework.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if homework.EndDate.After(time.Now()) </span><span class="cov8" title="1">{
                return nil, errors.New("评阅未开始")
        }</span>

        <span class="cov8" title="1">id, _ := c.Get("ID")
        if id == course.TeacherID </span><span class="cov8" title="1">{
                commentList, err := models.GetCommentsByHomeworkId(service.HomeworkID)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov8" title="1">return commentList, nil</span>
        }

        <span class="cov8" title="1">commentList, err := models.GetCommentListsByUserIDAndHomeworkID(id.(uint), service.HomeworkID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">var homework_submission []models.HomeworkSubmission
        for _, comment := range commentList </span><span class="cov8" title="1">{
                homework_submission = append(homework_submission, *models.GetHomeWorkSubmissionByID(comment.HomeworkSubmissionID))
        }</span>
        <span class="cov8" title="1">m := make(map[string]any)
        m["homework_submission"] = homework_submission
        m["comment_lists"] = commentList
        log.Printf("%x", len(commentList))
        return m, nil</span>
}

type GetMyCommentService struct {
        HomeworkID uint `uri:"id" binding:"required"`
}

func (service *GetMyCommentService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        homework, err := models.GetHomeworkByID(service.HomeworkID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if homework.EndDate.After(time.Now()) </span><span class="cov8" title="1">{
                return nil, errors.New("评阅未开始")
        }</span>
        <span class="cov8" title="1">id, _ := c.Get("ID")
        submission := models.GetHomeWorkSubmissionByHomeworkIDAndUserID(service.HomeworkID, id.(uint))
        if submission == nil </span><span class="cov0" title="0">{
                return nil, errors.New("作业未提交")
        }</span>
        <span class="cov8" title="1">comments, err := models.GetCommentBySubmissionID(submission.ID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return comments, nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package service

import (
        "errors"
        "homework_platform/internal/models"
        "log"

        "github.com/gin-gonic/gin"
)

type CreateComplaint struct {
        Reason     string `form:"reason"`
        HomeworkID uint   `uri:"id" binding:"required"`
}

func (service *CreateComplaint) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        //绑定id
        err := c.ShouldBindUri(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        //绑定reason
        <span class="cov8" title="1">err = c.ShouldBind(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">log.Printf("正在创建Complaint&lt;homeworkId:%d,reason:%s&gt;", service.HomeworkID, service.Reason)
        id, _ := c.Get("ID")
        if service.Reason == "" </span><span class="cov8" title="1">{
                return nil, errors.New("原因不能为空")
        }</span>
        <span class="cov8" title="1">homework_submission := models.GetHomeWorkSubmissionByHomeworkIDAndUserID(service.HomeworkID, id.(uint))
        if homework_submission == nil </span><span class="cov8" title="1">{
                return nil, errors.New("没有找到该提交")
        }</span>
        <span class="cov8" title="1">log.Printf("作业的用户为id%d", homework_submission.UserID)
        if homework_submission.UserID != id.(uint) </span><span class="cov0" title="0">{
                return nil, errors.New("这不是您的作业")
        }</span>
        <span class="cov8" title="1">homework, err := models.GetHomeworkByID(service.HomeworkID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">complaint, _ := models.GetComplaintByHomeworkIdAndUserId(homework.ID, id.(uint))
        if complaint != nil &amp;&amp; complaint.ID != 0 </span><span class="cov8" title="1">{
                return nil, errors.New("未查询")
        }</span>
        <span class="cov8" title="1">err = models.CreateTeacherComplaint(
                homework_submission.ID,
                homework_submission.HomeworkID,
                homework.CourseID,
                service.Reason,
        )
        return nil, err</span>
}

type DeleteComplaint struct {
        ComplaintId uint `uri:"id" binding:"required"`
}

func (service *DeleteComplaint) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        err := models.DeleteComplaint(service.ComplaintId)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return nil, nil</span>
}

type UpdateComplaint struct {
        ComplaintId uint   `uri:"id" binding:"required"`
        Reason      string `form:"reason"`
}

func (service *UpdateComplaint) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        //绑定id
        err := c.ShouldBindUri(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        //绑定reason
        <span class="cov8" title="1">err = c.ShouldBind(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if service.Reason == "" </span><span class="cov8" title="1">{
                return nil, errors.New("原因不能为空")
        }</span>
        <span class="cov8" title="1">complain, err := models.GetComplaintById(service.ComplaintId)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">log.Printf("修改reason为:%s", service.Reason)
        complain.Reason = service.Reason
        err = complain.Save()
        return nil, err</span>
}

type SolveComplaint struct {
        ComplaintId uint `uri:"id" binding:"required"`
}

func (service *SolveComplaint) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        complaint, err := models.GetComplaintById(service.ComplaintId)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">complaint.Solved = true
        err = complaint.Save()
        return nil, err</span>
}

type GetComplaint struct {
        HomeworkID uint `uri:"id" binding:"required"`
}

func (service *GetComplaint) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        id, _ := c.Get("ID")
        homework, err := models.GetHomeworkByID(service.HomeworkID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">course, err := models.GetCourseByID(homework.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if course.TeacherID == id </span><span class="cov8" title="1">{
                complaints, err := models.GetComplaintByHomeworkID(service.HomeworkID)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov8" title="1">return complaints, nil</span>
        } else<span class="cov8" title="1"> {
                submission := models.GetHomeWorkSubmissionByHomeworkIDAndUserID(service.HomeworkID, id.(uint))
                if submission == nil </span><span class="cov0" title="0">{
                        return nil, errors.New("未提交作业")
                }</span>
                <span class="cov8" title="1">complaint, err := models.GetComplaintBySubmissionID(submission.ID)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov8" title="1">return complaint, nil</span>
        }
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package service

import (
        "errors"
        "fmt"
        "homework_platform/internal/models"
        "log"
        "mime/multipart"

        // "net/http"
        "time"

        "github.com/gin-gonic/gin"
)

type CreateCourse struct {
        Name        string    `form:"name"`
        BeginDate   time.Time `form:"begindate"`
        EndDate     time.Time `form:"enddate"`
        Description string    `form:"description"`
}

func (service *CreateCourse) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        id, _ := c.Get("ID")
        if service.BeginDate.After(service.EndDate) </span><span class="cov8" title="1">{
                return nil, errors.New("开始时间晚于结束时间")
        }</span>
        <span class="cov8" title="1">if service.Name == "" </span><span class="cov8" title="1">{
                return nil, errors.New("课程名不能为空")
        }</span>
        <span class="cov8" title="1">id, err := models.CreateCourse(service.Name, service.BeginDate, service.EndDate, service.Description, id.(uint))
        return id, err</span>
}

type UpdateCourseDescription struct {
        CourseID    uint   `uri:"id" binding:"required"`
        Description string `form:"description"`
}

func (service *UpdateCourseDescription) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        var err error
        // 从 Uri 获取 CourseID
        err = c.ShouldBindUri(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        // 从 Form 获取其他数据
        <span class="cov8" title="1">err = c.ShouldBind(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">course, err := models.GetCourseByID(service.CourseID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">id, _ := c.Get("ID")
        if course.TeacherID != id </span><span class="cov8" title="1">{
                return nil, errors.New("不能修改不是您的课程")
        }</span>
        <span class="cov8" title="1">res := course.UpdateCourseDescription(service.Description)
        if !res </span><span class="cov0" title="0">{
                return nil, errors.New("创建失败")
        }</span>
        <span class="cov8" title="1">return nil, nil</span>
}

type DeleteCourse struct {
        CourseID uint `uri:"id" binding:"required"`
}

func (service *DeleteCourse) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        course, err := models.GetCourseByID(service.CourseID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">id, _ := c.Get("ID")
        if course.TeacherID != id </span><span class="cov8" title="1">{
                return nil, errors.New("不能修改不是您的课程")
        }</span>
        <span class="cov8" title="1">res := course.Deleteself()
        if res != nil </span><span class="cov0" title="0">{
                return nil, res
        }</span>
        <span class="cov8" title="1">return nil, nil</span>
}

type GetCourseStudents struct {
        CourseID uint `uri:"id" binding:"required"`
}

func (service *GetCourseStudents) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        course, err := models.GetCourseByID(service.CourseID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        // id, _ := c.Get("ID")
        // if course.TeacherID != id {
        //         return nil, errors.New("不能查看不是您的课程的学生列表")
        // }
        <span class="cov8" title="1">users, res := course.GetStudents()
        if res != nil </span><span class="cov0" title="0">{
                return nil, res
        }</span>
        <span class="cov8" title="1">return users, nil</span>
}

type AddCourseStudentService struct {
        CourseID uint `uri:"id" binding:"required"`
}

func (service *AddCourseStudentService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        course, err := models.GetCourseByID(service.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">id, _ := c.Get("ID")
        // 查看该用户是否已经选择了course
        res := course.GetStudentsByID(id.(uint))
        if res </span><span class="cov8" title="1">{
                return nil, errors.New("无法重复选课")
        }</span>

        <span class="cov8" title="1">user, err := models.GetUserByID(id.(uint))
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">user.LearningCourses = append(user.LearningCourses, &amp;course)
        result := models.DB.Save(&amp;user)
        if result.Error != nil </span><span class="cov0" title="0">{
                return nil, result.Error
        }</span>
        <span class="cov8" title="1">return nil, nil</span>
}

type GetCourseStudentLists struct {
        CourseID uint `form:"courseid"`
}

func (service *GetCourseStudentLists) Handle(c *gin.Context) (any, error) <span class="cov0" title="0">{
        course, err := models.GetCourseByID(service.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">id, _ := c.Get("ID")
        if course.TeacherID != id </span><span class="cov0" title="0">{
                return nil, errors.New("不能查看不是您的课程的学生列表")
        }</span>
        <span class="cov0" title="0">users, res := course.GetStudents()
        if res != nil </span><span class="cov0" title="0">{
                return nil, res
        }</span>
        <span class="cov0" title="0">return users, nil</span>
}

type SelectCourseService struct {
        CourseID uint `form:"courseid"`
}

func (service *SelectCourseService) Handle(c *gin.Context) (any, error) <span class="cov0" title="0">{
        course, err := models.GetCourseByID(service.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">id, _ := c.Get("ID")
        res := course.SelectCourse(id.(uint))
        return nil, res</span>
}

// type GetTeachingCourse struct {
// }

// func (service *GetTeachingCourse) Handle(c *gin.Context) (any, error) {
//         id, _ := c.Get("ID")
//         user, err := models.GetUserByID(id.(uint))
//         if err != nil {
//                 return nil, err
//         }
//         courses, res := user.GetTeachingCourse()
//         if res != nil {
//                 return nil, res
//         }
//         return courses, nil
// }

// type GetLearningCourse struct{}

// func (service *GetLearningCourse) Handle(c *gin.Context) (any, error) {
//         id, _ := c.Get("ID")
//         user, err := models.GetUserByID(id.(uint))
//         if err != nil {
//                 return nil, err
//         }
//         courses, res := user.GetLearningCourse()
//         if res != nil {
//                 return nil, res
//         }
//         return courses, nil
// }

type GetCourses struct{}

func (service *GetCourses) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        courses, err := models.GetCourses()
        return courses, err
}</span>

type GetCourse struct {
        ID uint `uri:"id" binding:"required"`
}

func (service *GetCourse) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        fmt.Println(*service)
        course, err := models.GetCourseByID(service.ID)
        return course, err
}</span>

type StudentHomework struct {
        models.Homework
        Submitted bool `json:"submitted"`
        Score     int  `json:"score"`
}

type GetCourseHomeworks struct {
        CourseID uint `uri:"id" binding:"required"`
}

func (service *GetCourseHomeworks) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        course, err := models.GetCourseByID(service.CourseID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">homeworks, err := course.GetHomeworkLists()
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">id := c.GetUint("ID")
        if id != course.TeacherID </span><span class="cov0" title="0">{
                studentHomeworks := []StudentHomework{}
                for _, homework := range homeworks </span><span class="cov0" title="0">{
                        studentHomework := StudentHomework{
                                Homework:  homework,
                                Submitted: false,
                                Score:     -1,
                        }

                        homeworkSubmission := models.GetHomeWorkSubmissionByHomeworkIDAndUserID(homework.ID, id)
                        if homeworkSubmission != nil </span><span class="cov0" title="0">{
                                studentHomework.Submitted = true
                                studentHomework.Score = homeworkSubmission.Score
                        }</span>

                        <span class="cov0" title="0">studentHomeworks = append(studentHomeworks, studentHomework)</span>
                }
                <span class="cov0" title="0">return studentHomeworks, nil</span>
        } else<span class="cov8" title="1"> {
                // TODO: Frontend oriented 的老师需要的作业信息（比如额外增加提交人数统计等）
                return homeworks, nil
        }</span>
}

// This is a special one using no bindings (manualy do the bindings in Handle func)
type CreateCourseHomework struct {
        CourseID       uint                    `uri:"id" binding:"required"`
        Name           string                  `form:"name"`
        Description    string                  `form:"description"`
        BeginDate      time.Time               `form:"beginDate"`
        EndDate        time.Time               `form:"endDate"`
        CommentEndDate time.Time               `form:"commentEndDate"`
        Files          []*multipart.FileHeader `form:"files"`
}

func (s *CreateCourseHomework) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        if c.ContentType() != "multipart/form-data" </span><span class="cov0" title="0">{
                return nil, errors.New("not supported content-type")
        }</span>

        <span class="cov8" title="1">var err error
        // 从 Uri 获取 CourseID
        err = c.ShouldBindUri(s)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        // 从 Form 获取其他数据
        <span class="cov8" title="1">err = c.ShouldBind(s)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">log.Print(s)
        if s.Name == "" </span><span class="cov8" title="1">{
                return nil, errors.New("名称不能为空")
        }</span>
        <span class="cov8" title="1">if len(s.Files) == 0 &amp;&amp; s.Description == "" </span><span class="cov0" title="0">{
                log.Printf("作业没有内容")
                return nil, errors.New("内容不能为空")
        }</span>
        <span class="cov8" title="1">if s.BeginDate.After(s.EndDate) || s.EndDate.After(s.CommentEndDate) </span><span class="cov8" title="1">{
                log.Printf("时间混乱")
                return nil, errors.New("时间顺序错误")
        }</span>
        // 获取课程
        <span class="cov8" title="1">course, err := models.GetCourseByID(s.CourseID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        // 获取请求者 ID
        <span class="cov8" title="1">id, _ := c.Get("ID")
        if course.TeacherID != id </span><span class="cov8" title="1">{
                return nil, errors.New("不能发布不是您的课程的作业")
        }</span>
        // 创建课程
        <span class="cov8" title="1">homework, err2 := models.CreateHomework(
                s.CourseID,
                s.Name,
                s.Description,
                s.BeginDate,
                s.EndDate,
                s.CommentEndDate,
        )
        if err2 != nil </span><span class="cov8" title="1">{
                return nil, errors.New("创建失败")
        }</span>
        // 保存课程文件
        <span class="cov8" title="1">for _, f := range s.Files </span><span class="cov8" title="1">{
                log.Println(f.Filename)
                dst := fmt.Sprintf("./data/homeworkassign/%d/%s", homework.(models.Homework).ID, f.Filename)
                // 上传文件到指定的目录
                c.SaveUploadedFile(f, dst)
        }</span>
        <span class="cov8" title="1">return homework.(models.Homework).ID, nil</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package service

import (
        "errors"
        "io"
        "log"
        "os"
        "strings"

        "github.com/gin-gonic/gin"
)

type GetFileService struct {
        // FilePath string `uri:"path" binding:"required"`
}

func (service *GetFileService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        c.Header("Content-Disposition", "attachment")
        filePath := c.Param("path")[1:]
        println(filePath)
        if !strings.HasPrefix(filePath, "./data") &amp;&amp; !strings.HasPrefix(filePath, "data") </span><span class="cov8" title="1">{
                return nil, errors.New("无法访问该文件")
        }</span>
        <span class="cov8" title="1">log.Printf("path:%s", filePath)
        f, err := os.OpenFile(filePath, os.O_RDONLY, 0666)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">defer f.Close()

        // 将文件内容写入HTTP响应
        _, err = io.Copy(c.Writer, f)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return nil, nil</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package service

import (
        "errors"
        "homework_platform/internal/models"
        "log"

        "github.com/gin-gonic/gin"
)

type GetGradeBySubmissionIDService struct {
        HomeworkSubmissionID uint `uri:"id" binding:"required"`
}

func (service *GetGradeBySubmissionIDService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        submission := models.GetHomeWorkSubmissionByID(service.HomeworkSubmissionID)
        if submission == nil </span><span class="cov8" title="1">{
                return nil, errors.New("作业没找到")
        }</span>
        <span class="cov8" title="1">return submission.Score, nil</span>
}

type UpdateGradeService struct {
        HomeworkSubmissionID uint `uri:"id" binding:"required"`
        Score                int  `form:"score"`
}

func (service *UpdateGradeService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        err := c.ShouldBindUri(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        //绑定reason
        <span class="cov8" title="1">err = c.ShouldBind(service)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if service.Score &lt; 0 || service.Score &gt; 100 </span><span class="cov8" title="1">{
                return nil, errors.New("无效成绩")
        }</span>
        <span class="cov8" title="1">submission := models.GetHomeWorkSubmissionByID(service.HomeworkSubmissionID)
        if submission == nil </span><span class="cov8" title="1">{
                return nil, errors.New("作业没找到")
        }</span>
        <span class="cov8" title="1">homework, res := models.GetHomeworkByID(submission.HomeworkID)
        if res != nil </span><span class="cov0" title="0">{
                return nil, res
        }</span>
        <span class="cov8" title="1">course, err := models.GetCourseByID(homework.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">id, _ := c.Get("ID")
        if id.(uint) != course.TeacherID </span><span class="cov8" title="1">{
                return nil, errors.New("您无权限修改")
        }</span>
        <span class="cov8" title="1">submission.Score = service.Score
        // submission.Grade = service.Final
        err2 := submission.UpdateSelf()
        //TODO:还需要更新那些人的置信度,但是我是懒B
        return nil, err2</span>
}

type GetGradeListsByHomeworkIDService struct {
        HomeworkID uint `uri:"id" binding:"required"`
}

type MyMap struct {
        UserID   uint   `form:"userId"`
        UserName string `form:"userName"`
        Score    int    `form:"score"`
}

func (service *GetGradeListsByHomeworkIDService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        homework, res := models.GetHomeworkByID(service.HomeworkID)
        if res != nil </span><span class="cov8" title="1">{
                return nil, res
        }</span>
        <span class="cov8" title="1">course, err := models.GetCourseByID(homework.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">id, _ := c.Get("ID")
        if id.(uint) != course.TeacherID </span><span class="cov8" title="1">{
                //学生自己查
                submission := models.GetHomeWorkSubmissionByHomeworkIDAndUserID(service.HomeworkID, id.(uint))
                if submission==nil</span><span class="cov0" title="0">{
                        return nil,errors.New("未提交作业")
                }</span>
                <span class="cov8" title="1">var maps MyMap
                maps.UserID = id.(uint)
                maps.Score = submission.Score
                maps.UserName = "yourself"
                log.Println(maps)
                return maps, nil</span>
        } else<span class="cov8" title="1"> {
                submissions, err2 := models.GetSubmissionListsByHomeworkID(service.HomeworkID)
                if err2 != nil </span><span class="cov0" title="0">{
                        return nil, err2
                }</span>
                <span class="cov8" title="1">var maps []MyMap
                for _, submission := range submissions </span><span class="cov8" title="1">{
                        user, err := models.GetUserByID(submission.UserID)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, err
                        }</span>
                        <span class="cov8" title="1">maps = append(maps, MyMap{UserID: user.ID, UserName: user.Username, Score: submission.Score})</span>
                }
                <span class="cov8" title="1">return maps, nil</span>
        }
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package service

import (
        "errors"
        "fmt"
        "homework_platform/internal/models"
        "log"
        "mime/multipart"
        "os"
        "path/filepath"
        "time"

        "github.com/gin-gonic/gin"
)

type GetHomework struct {
        ID uint `uri:"id" binding:"required"`
}

func (service *GetHomework) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        homework, err2 := models.GetHomeworkByID(uint(service.ID))
        if err2 != nil </span><span class="cov8" title="1">{
                return nil, errors.New("没有找到该作业")
        }</span>
        <span class="cov8" title="1">path := fmt.Sprintf("./data/homeworkassign/%d", service.ID)
        files, err := os.ReadDir(path)
        homework.FilePaths = make([]string, 0)
        if err == nil </span><span class="cov8" title="1">{
                for _, file := range files </span><span class="cov8" title="1">{
                        filePath := filepath.Join(path, file.Name())
                        homework.FilePaths = append(homework.FilePaths, filePath)
                }</span>
        }

        <span class="cov8" title="1">course, err := models.GetCourseByID(homework.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">id := c.GetUint("ID")
        if id != course.TeacherID </span><span class="cov0" title="0">{
                studentHomework := StudentHomework{
                        Homework:  homework,
                        Submitted: false,
                        Score:     -1,
                }

                homeworkSubmission := models.GetHomeWorkSubmissionByHomeworkIDAndUserID(homework.ID, id)
                if homeworkSubmission != nil </span><span class="cov0" title="0">{
                        studentHomework.Submitted = true
                        studentHomework.Score = homeworkSubmission.Score
                }</span>

                <span class="cov0" title="0">return studentHomework, nil</span>
        }
        <span class="cov8" title="1">return homework, nil</span>
}

type AssignHomeworkService struct {
        CourseID       uint                    `form:"courseId"`
        Name           string                  `form:"name"`
        Description    string                  `form:"description"`
        BeginDate      time.Time               `form:"beginDate"`
        EndDate        time.Time               `form:"endDate"`
        CommentEndDate time.Time               `form:"commentEndDate"`
        Files          []*multipart.FileHeader `form:"files"`
}

func (service *AssignHomeworkService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        course, err := models.GetCourseByID(service.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">id, _ := c.Get("ID")
        if course.TeacherID != id </span><span class="cov8" title="1">{
                return nil, errors.New("不能发布不是您的课程的作业")
        }</span>
        //CourseID
        <span class="cov8" title="1">homework, err2 := models.CreateHomework(
                service.CourseID,
                service.Name,
                service.Description,
                service.BeginDate,
                service.EndDate,
                service.CommentEndDate,
        )
        if err2 != nil </span><span class="cov0" title="0">{
                return nil, errors.New("创建失败")
        }</span>
        <span class="cov8" title="1">for _, f := range service.Files </span><span class="cov8" title="1">{
                log.Println(f.Filename)
                dst := fmt.Sprintf("./data/homeworkassign/%d/%s", homework.(models.Homework).ID, f.Filename)
                // 上传文件到指定的目录
                c.SaveUploadedFile(f, dst)
        }</span>

        <span class="cov8" title="1">return homework.(models.Homework).ID, nil</span>
}

type HomeworkLists struct {
        CourseID uint `uri:"id" binding:"required"`
}

func (service *HomeworkLists) Handle(c *gin.Context) (any, error) <span class="cov0" title="0">{
        course, err := models.GetCourseByID(service.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        // id, _ := c.Get("ID")
        // if course.TeacherID != id {
        //         return nil, errors.New("不能查看不是您的课程的作业")
        // }
        <span class="cov0" title="0">homeworks, err2 := course.GetHomeworkLists()
        if err2 != nil </span><span class="cov0" title="0">{
                return nil, err2
        }</span>
        <span class="cov0" title="0">return homeworks, nil</span>
}

type DeleteHomework struct {
        HomeworkID uint `uri:"id" bind:"required"`
}

func (service *DeleteHomework) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        homework, err2 := models.GetHomeworkByID(uint(service.HomeworkID))
        if err2 != nil </span><span class="cov8" title="1">{
                return nil, err2
        }</span>
        <span class="cov8" title="1">course, err := models.GetCourseByID(homework.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">id, _ := c.Get("ID")
        if course.TeacherID != id </span><span class="cov8" title="1">{
                return nil, errors.New("不能删除不是您的课程的作业")
        }</span>
        <span class="cov8" title="1">if err := homework.Deleteself(); err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">dirPath := fmt.Sprintf("./data/homeworkassign/%d/%d", course.ID, service.HomeworkID)
        os.RemoveAll(dirPath)

        return nil, nil</span>
}

type UpdateHomework struct {
        HomeworkID     uint                    `uri:"id" bind:"required"`
        Name           string                  `form:"name"`
        Description    string                  `form:"description"`
        BeginDate      time.Time               `form:"beginDate"`
        EndDate        time.Time               `form:"endDate"`
        CommentEndDate time.Time               `form:"commentEndDate"`
        Files          []*multipart.FileHeader `form:"files"`
}

func (s *UpdateHomework) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        var err error
        // 从 Uri 获取 CourseID
        err = c.ShouldBindUri(s)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        // 从 Form 获取其他数据
        <span class="cov8" title="1">err = c.ShouldBind(s)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">log.Println(s)
        if s.Name == "" </span><span class="cov8" title="1">{
                return nil, errors.New("名称不能为空")
        }</span>
        <span class="cov8" title="1">if len(s.Files) == 0 &amp;&amp; s.Description == "" </span><span class="cov0" title="0">{
                log.Printf("作业没有内容")
                return nil, errors.New("内容不能为空")
        }</span>
        <span class="cov8" title="1">if s.BeginDate.After(s.EndDate) || s.EndDate.After(s.CommentEndDate) </span><span class="cov8" title="1">{
                log.Printf("时间混乱")
                return nil, errors.New("时间顺序错误")
        }</span>
        <span class="cov8" title="1">homework, err := models.GetHomeworkByID(s.HomeworkID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">course, err := models.GetCourseByID(homework.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">id, _ := c.Get("ID")
        if course.TeacherID != id </span><span class="cov8" title="1">{
                return nil, errors.New("不能修改不是您的课程的作业")
        }</span>

        // TODO: 已经被分配了 需要特殊处理
        <span class="cov8" title="1">if homework.Assigned == 1 </span><span class="cov0" title="0">{
                //如果提后了提交时间,那么就要重新设置
                if s.EndDate.After(time.Now()) </span><span class="cov0" title="0">{
                        homework.Assigned = -1
                        //删除现有评论并且把分数置为0
                        err := models.DeleteCommentsByHomeworkID(homework.ID)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, err
                        }</span>
                        <span class="cov0" title="0">homework_submission := models.GetHomeWorkSubmissionListsByHomeworkID(homework.ID)
                        for _, submission := range homework_submission </span><span class="cov0" title="0">{
                                submission.Score = -1
                                err := submission.UpdateSelf()
                                if err != nil </span><span class="cov0" title="0">{
                                        return nil, err
                                }</span>
                        }
                        <span class="cov0" title="0">models.DB.Save(&amp;homework)</span>
                }
        }

        <span class="cov8" title="1">homework.UpdateInformation(s.Name, s.Description, s.BeginDate, s.EndDate, s.CommentEndDate)
        os.RemoveAll(fmt.Sprintf("./data/homeworkassign/%d/%d", homework.CourseID, homework.ID))

        for _, f := range s.Files </span><span class="cov8" title="1">{
                log.Println(f.Filename)
                dst := fmt.Sprintf("./data/homeworkassign/%d/%d/%s", homework.CourseID, homework.ID, f.Filename)
                // 上传文件到指定的目录
                c.SaveUploadedFile(f, dst)
        }</span>
        <span class="cov8" title="1">return nil, nil</span>
}

// type SubmitListsService struct {
//         HomeworkID uint `uri:"id" binding:"required"`
// }

// func (service *SubmitListsService) Handle(c *gin.Context) (any, error) {
//         query := c.Request.URL.Query()
//         category := query.Get("all")
//         if category == "true" {
//                 homework, err2 := models.GetHomeworkByIDWithSubmissionLists(uint(service.HomeworkID))
//                 if err2 != nil {
//                         return nil, errors.New("没有找到该作业")
//                 }
//                 CourseID := homework.CourseID
//                 course, err := models.GetCourseByID(CourseID)
//                 if err != nil {
//                         return nil, err
//                 }
//                 id, _ := c.Get("ID")
//                 if course.TeacherID != id {
//                         return nil, errors.New("不能查看不是您的课程的作业")
//                 }
//                 for i := 0; i &lt; len(homework.HomeworkSubmissions); i++ {
//                         root := fmt.Sprintf("./data/homeworkassign/%d/", homework.HomeworkSubmissions[i].ID)
//                         files, err := os.ReadDir(root)
//                         if err == nil {
//                                 for _, file := range files {
//                                         if file.IsDir() {
//                                                 continue
//                                         }
//                                         homework.HomeworkSubmissions[i].FilePaths = append(homework.HomeworkSubmissions[i].FilePaths, filepath.Join(root, file.Name()))
//                                 }
//                         }
//                 }
//                 return homework.HomeworkSubmissions, nil
//         } else {
//                 id, _ := c.Get("ID")
//                 id = id.(uint)
//                 homework, err := models.GetHomeworkByIDWithSubmissionLists(service.HomeworkID)
//                 if err != nil {
//                         return "该作业号不存在", nil
//                 }
//                 for _, value := range homework.HomeworkSubmissions {
//                         if value.UserID == id {
//                                 return value, nil
//                         }
//                 }
//                 return nil, errors.New("该用户未提交作业")
//         }
// }
</pre>
		
		<pre class="file" id="file7" style="display: none">package service

import (
        "errors"
        "fmt"
        "homework_platform/internal/models"
        "log"
        "mime/multipart"
        "os"
        "time"

        "github.com/gin-gonic/gin"
)

type SubmitHomework struct {
        HomeworkID uint                    `uri:"id" bind:"required"`
        Content    string                  `form:"content"`
        Files      []*multipart.FileHeader `form:"files"`
}

func (s *SubmitHomework) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        if c.ContentType() != "multipart/form-data" </span><span class="cov0" title="0">{
                return nil, errors.New("not supported content-type")
        }</span>

        <span class="cov8" title="1">var err error
        // 从 Uri 获取 HomeworkID
        err = c.ShouldBindUri(s)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        // 从 Form 获取其他数据
        <span class="cov8" title="1">err = c.ShouldBind(s)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">id, _ := c.Get("ID")
        time := time.Now()
        homework, err := models.GetHomeworkByID(uint(s.HomeworkID))
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if homework.EndDate.Before(time) </span><span class="cov0" title="0">{
                return nil, errors.New("超时提交")
        }</span>
        <span class="cov8" title="1">course, err := models.GetCourseByID(homework.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">log.Printf("正在检查该用户有没有选课%d", id.(uint))
        if !course.FindStudents(id.(uint)) </span><span class="cov0" title="0">{
                return nil, errors.New("请先选择这门课")
        }</span>
        <span class="cov8" title="1">homworksubmission := models.GetHomeWorkSubmissionByHomeworkIDAndUserID(uint(s.HomeworkID), id.(uint))
        if homworksubmission == nil </span><span class="cov8" title="1">{
                homworksubmission := models.HomeworkSubmission{
                        HomeworkID: uint(s.HomeworkID),
                        Content:    s.Content,
                        UserID:     id.(uint),
                }
                res := models.AddHomeworkSubmission(&amp;homworksubmission)
                if !res </span><span class="cov0" title="0">{
                        return nil, errors.New("提交失败")
                }</span>
                <span class="cov8" title="1">for _, f := range s.Files </span><span class="cov8" title="1">{
                        log.Println(f.Filename)
                        dst := fmt.Sprintf("./data/homework_submission/%d/%s", homworksubmission.ID, f.Filename)
                        // 上传文件到指定的目录
                        c.SaveUploadedFile(f, dst)
                }</span>
                <span class="cov8" title="1">return nil, nil</span>
        }
        <span class="cov8" title="1">return nil, errors.New("不可重复提交")</span>
}

type GetHomeworkSubmission struct {
        HomeworkId uint `uri:"id" binding:"required"`
}

func (service *GetHomeworkSubmission) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        userid, _ := c.Get("ID")
        log.Printf("用户id为%d", userid.(uint))
        log.Printf("homeworkid为%d", service.HomeworkId)
        homework, err := models.GetHomeworkByIDWithSubmissionLists(service.HomeworkId)
        if err != nil </span><span class="cov0" title="0">{
                return "该作业号不存在", nil
        }</span>
        <span class="cov8" title="1">for _, value := range homework.HomeworkSubmissions </span><span class="cov8" title="1">{
                if value.UserID == userid.(uint) </span><span class="cov8" title="1">{
                        value.GetFiles()
                        return value, nil
                }</span>
        }
        <span class="cov8" title="1">return nil, errors.New("该用户未提交作业")</span>
}

type UpdateSubmission struct {
        HomeworkID uint                    `uri:"id" bind:"required"`
        Content    string                  `form:"content"`
        Files      []*multipart.FileHeader `form:"files"`
}

func (s *UpdateSubmission) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        if c.ContentType() != "multipart/form-data" </span><span class="cov0" title="0">{
                return nil, errors.New("not supported content-type")
        }</span>

        <span class="cov8" title="1">var err error
        // 从 Uri 获取 HomeworkID
        err = c.ShouldBindUri(s)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        // 从 Form 获取其他数据
        <span class="cov8" title="1">err = c.ShouldBind(s)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">log.Println(s)

        id, _ := c.Get("ID")
        time := time.Now()
        homework, err := models.GetHomeworkByID(uint(s.HomeworkID))
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if homework.EndDate.Before(time) </span><span class="cov0" title="0">{
                return nil, errors.New("超时提交")
        }</span>
        <span class="cov8" title="1">course, err := models.GetCourseByID(homework.CourseID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if !course.FindStudents(id.(uint)) </span><span class="cov8" title="1">{
                return nil, errors.New("请先选择这门课")
        }</span>
        <span class="cov8" title="1">homworksubmission := models.GetHomeWorkSubmissionByHomeworkIDAndUserID(uint(s.HomeworkID), id.(uint))
        if homworksubmission != nil </span><span class="cov8" title="1">{
                homworksubmission.Content = s.Content
                homworksubmission.UpdateSelf()
                os.RemoveAll(fmt.Sprintf("./data/homework_submission/%d", homworksubmission.ID))
                for _, f := range s.Files </span><span class="cov8" title="1">{
                        log.Println(f.Filename)
                        dst := fmt.Sprintf("./data/homework_submission/%d/%s", homworksubmission.ID, f.Filename)
                        // 上传文件到指定的目录
                        c.SaveUploadedFile(f, dst)
                }</span>
                <span class="cov8" title="1">return nil, nil</span>
        }
        <span class="cov0" title="0">return nil, errors.New("请先提交作业")</span>
}

type GetSubmissionService struct {
        HomeworkID uint `uri:"id" bind:"required"`
}

func (s *GetSubmissionService) Handle(c *gin.Context) (any, error) <span class="cov0" title="0">{
        submit := models.GetHomeWorkSubmissionByID(s.HomeworkID)
        submit.GetFiles()
        return submit, nil
}</span>
</pre>
		
		<pre class="file" id="file8" style="display: none">package service

import (
        "homework_platform/internal/serializer"
        "log"
        "net/http"

        "github.com/gin-gonic/gin"
)

const (
        Bind = iota
        BindUri
        None
)

type Service interface {
        Handle(c *gin.Context) (any, error)
}

func HandlerNoBind(s Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                var err error

                res, err := s.Handle(c) //调用实现了接口s的结构体对代码进行处理
                if err != nil </span><span class="cov8" title="1">{
                        log.Println(err.Error())
                        c.JSON(http.StatusBadRequest, serializer.ErrorResponse(err))
                }</span> else<span class="cov8" title="1"> {
                        log.Println("StatusOK")
                        c.JSON(http.StatusOK, serializer.Response(res))
                }</span>
        }
}

func Handler(s Service) gin.HandlerFunc <span class="cov8" title="1">{
        return HandlerWithBindType(s, Bind)
}</span>

func HandlerBindUri(s Service) gin.HandlerFunc <span class="cov8" title="1">{
        return HandlerWithBindType(s, BindUri)
}</span>

func HandlerWithBindType(s Service, bindType int) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                var err error
                
                // Binding using an auto-selected binding engine
                // "application/json" --&gt; JSON binding
                // "application/xml"  --&gt; XML binding
                switch bindType </span>{
                case Bind:<span class="cov8" title="1">
                        err = c.ShouldBind(s)</span>
                case BindUri:<span class="cov8" title="1">
                        err = c.ShouldBindUri(s)</span>
                case None:<span class="cov0" title="0">
                        err = nil</span>
                }
                <span class="cov8" title="1">if err != nil /*&amp;&amp; err != io.EOF*/ </span><span class="cov0" title="0">{
                        log.Printf("[Handler]: Failed to bind: %v\n", err)
                        c.JSON(http.StatusBadRequest, serializer.ErrorResponse(err))
                        return
                }</span>

                <span class="cov8" title="1">res, err := s.Handle(c) //调用实现了接口s的结构体对代码进行处理
                if err != nil </span><span class="cov8" title="1">{
                        log.Println(err.Error())
                        c.JSON(http.StatusBadRequest, serializer.ErrorResponse(err))
                }</span> else<span class="cov8" title="1"> {
                        log.Println("StatusOK")
                        c.JSON(http.StatusOK, serializer.Response(res))
                }</span>
        }
}
</pre>
		
		<pre class="file" id="file9" style="display: none">package service

import (
        "homework_platform/internal/jwt"
        "homework_platform/internal/models"
        "time"

        "errors"
        "log"

        "github.com/gin-gonic/gin"
        "gorm.io/gorm"
)

type UserLoginService struct {
        Username string `form:"username"`
        Password string `form:"password"`
}

func (service *UserLoginService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        log.Printf("[UserLoginService]: %v, %v\n", service.Username, service.Password)
        var user models.User
        var err error

        if user, err = models.GetUserByUsername(service.Username); err == gorm.ErrRecordNotFound </span><span class="cov8" title="1">{
                return nil, errors.New("not exist")
        }</span>

        <span class="cov8" title="1">if !user.CheckPassword(service.Password) </span><span class="cov8" title="1">{
                return nil, errors.New("incorrect password")
        }</span>

        <span class="cov8" title="1">var jwtToken string
        jwtToken, err = jwt.CreateToken(user.ID) //根据用id创建jwt
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">res := make(map[string]any)
        res["token"] = jwtToken //之后解码token验证和user是否一致
        res["user"] = user
        // res["user_name"] = user.Username
        log.Printf("登陆成功")
        return res, nil</span>
}

// 自己修改密码
type UserselfupdateService struct {
        UserName    string `form:"userName"`
        OldPassword string `form:"oldPassword"` // 旧码
        NewPassword string `form:"newPassword"` //新密码
}

func (service *UserselfupdateService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        user, err := models.GetUserByUsername(service.UserName)
        if err != nil </span><span class="cov8" title="1">{
                return nil, errors.New("该用户不存在")
        }</span>
        //验证密码
        <span class="cov8" title="1">passwordCheck := user.CheckPassword(service.OldPassword)
        if !passwordCheck </span><span class="cov8" title="1">{
                return nil, errors.New("密码错误")
        }</span>
        //修改密码
        <span class="cov8" title="1">result := user.ChangePassword(service.NewPassword)
        if !result </span><span class="cov0" title="0">{
                return nil, errors.New("修改失败")
        }</span>
        <span class="cov8" title="1">res := make(map[string]any)
        res["msg"] = "修改成功"
        return res, nil</span>
}

type GetUserService struct {
        ID uint `uri:"id" binding:"required"`
}

func (service *GetUserService) Handle(c *gin.Context) (any, error) <span class="cov0" title="0">{
        return models.GetUserByID(service.ID)
}</span>

type UserRegisterService struct {
        Username string `form:"username"` // 用户名
        Password string `form:"password"` // 密码
}

func (service *UserRegisterService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        _, err := models.CreateUser(service.Username, service.Password)
        return nil, err
}</span>

type GetUserCoursesService struct {
        ID uint `uri:"id" binding:"required"`
}

func (service *GetUserCoursesService) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        user, err := models.GetUserByID(service.ID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return user.GetCourses()</span>
}

type UpdateSignature struct {
        Signature string `form:"signature"`
}

func (Service *UpdateSignature) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        id, exist := c.Get("ID")
        if !exist </span><span class="cov0" title="0">{
                return nil, errors.New("不存在id")
        }</span>
        <span class="cov8" title="1">user, err := models.GetUserByID(id.(uint))
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">if err := user.ChangeSignature(Service.Signature); err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return nil, nil</span>
}

type GetUserNotifications struct {
        ID uint `uri:"id" binding:"required"`
}

type Notifications struct {
        Type string `json:"type"`

        TeachingHomeworkListsToFinish  []models.Homework `json:"homeworkInProgress"`
        TeachingHomeworkListsToComment []models.Homework `json:"commentInProgress"`

        ComplaintToBeSolved []models.Complaint `json:"complaintToBeSolved"`
        ComplaintInProgress []models.Complaint `json:"complaintInProgress"`

        LeaningHomeworkListsToFinish  []models.Homework `json:"homeworksToBeCompleted"`
        LeaningHomeworkListsToComment []models.Homework `json:"commentToBeCompleted"`
}

// 返回应该尚未提交的作业,待批阅的作业和每门课最新发布的作业
func (service *GetUserNotifications) Handle(c *gin.Context) (any, error) <span class="cov8" title="1">{
        user, err := models.GetUserByID(service.ID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">courses, err := user.GetCourses()
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">var notifications Notifications
        //得到教的课中进行中和批阅中的作业
        log.Printf("len of homework%d\n", len(courses.LearningCourses))
        //得到学的课中还没完成的作业和还没批阅的作业
        for _, course := range courses.LearningCourses </span><span class="cov8" title="1">{
                //每门课的作业
                homeworks, err := course.GetHomeworkLists()
                if homeworks == nil </span><span class="cov0" title="0">{
                        continue</span>
                }
                <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov8" title="1">for j := 0; j &lt; len(homeworks); j++ </span><span class="cov8" title="1">{
                        // 在批阅时段中
                        if homeworks[j].CommentEndDate.After(time.Now()) </span><span class="cov8" title="1">{
                                // 作业已经开始
                                if homeworks[j].BeginDate.Before(time.Now()) </span><span class="cov8" title="1">{
                                        // 作业在提交时段内
                                        if homeworks[j].EndDate.After(time.Now()) </span><span class="cov8" title="1">{
                                                homework := models.GetHomeWorkSubmissionByHomeworkIDAndUserID(homeworks[j].ID, user.ID)
                                                // 没交作业
                                                if homework == nil </span><span class="cov0" title="0">{
                                                        notifications.LeaningHomeworkListsToFinish =
                                                                append(notifications.LeaningHomeworkListsToFinish, homeworks[j])
                                                }</span>
                                        } else<span class="cov8" title="1"> {
                                                // 评论时段内,获取所有的comment
                                                comments, err := models.GetCommentListsByUserIDAndHomeworkID(user.ID, homeworks[j].ID)
                                                if err != nil </span><span class="cov0" title="0">{
                                                        return nil, err
                                                }</span>
                                                // 如果有score==-1就代表尚未完成评论
                                                <span class="cov8" title="1">for i := 0; i &lt; len(comments); i++ </span><span class="cov8" title="1">{
                                                        if comments[i].Score == -1 </span><span class="cov0" title="0">{
                                                                notifications.LeaningHomeworkListsToComment =
                                                                        append(notifications.TeachingHomeworkListsToComment, homeworks[j])
                                                                break</span>
                                                        }
                                                }
                                        }
                                }
                        }
                }
        }
        //得到老师的课正在进行的作业
        <span class="cov8" title="1">for _, course := range courses.TeachingCourses </span><span class="cov8" title="1">{
                // 教的课中的作业
                homeworks, err := course.GetHomeworkLists()
                if homeworks == nil </span><span class="cov0" title="0">{
                        continue</span>
                }
                <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov8" title="1">for j := 0; j &lt; len(homeworks); j++ </span><span class="cov8" title="1">{
                        // comment尚未结束
                        if homeworks[j].CommentEndDate.After(time.Now()) </span><span class="cov8" title="1">{
                                //作业已经开始
                                if homeworks[j].BeginDate.Before(time.Now()) </span><span class="cov8" title="1">{
                                        //在提交时段内
                                        if homeworks[j].EndDate.After(time.Now()) </span><span class="cov8" title="1">{
                                                notifications.TeachingHomeworkListsToFinish =
                                                        append(notifications.TeachingHomeworkListsToFinish, homeworks[j])
                                        }</span> else<span class="cov0" title="0"> {
                                                notifications.TeachingHomeworkListsToComment =
                                                        append(notifications.TeachingHomeworkListsToComment, homeworks[j])
                                        }</span>
                                }
                        }
                }
        }
        //得到老师待审核的complaint
        <span class="cov8" title="1">notifications.ComplaintToBeSolved, err = models.GetComplaintByTeacherID(user.ID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        //得到学生还未被处理的complaint
        <span class="cov8" title="1">notifications.ComplaintInProgress, err = models.GetComplaintByUserID(user.ID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">return notifications, nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
